<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
<title>CHEZ ‚Äî Fan Photo Drop</title>
<style>
:root{--bg:#0b0b0f;--fg:#f5f5f7;--muted:#a8a8b3;--accent:#ff4d8d;--card:#14141a}
*{box-sizing:border-box}body{margin:0;font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Inter,Helvetica,Arial;background:radial-gradient(1200px 700px at 80% -10%,#1b1b25 0%,#0b0b0f 60%);color:var(--fg)}
.wrap{max-width:980px;margin:0 auto;padding:16px 16px 64px}
header{display:flex;align-items:center;justify-content:space-between;padding:20px 0}
.brand{font-weight:800;letter-spacing:.5px}
.badge{font-size:.85rem;background:rgba(255,77,141,.08);border:1px solid rgba(255,77,141,.35);padding:6px 10px;border-radius:999px;color:#fff}
.card{background:var(--card);border:1px solid #2a2a35;border-radius:20px;padding:20px;box-shadow:0 10px 30px rgba(0,0,0,.35)}
h1{font-size:1.4rem;margin:0 0 6px}p{margin:.2rem 0;color:var(--muted)}
button{appearance:none;border:0;border-radius:14px;padding:14px 18px;font-size:1rem;font-weight:700;cursor:pointer}
.primary{background:linear-gradient(135deg,#ff4d8d,#ff7a59);color:white}.ghost{background:transparent;border:1px solid #3a3a45;color:var(--fg)}
.row{display:flex;gap:16px;flex-wrap:wrap}
.hero{display:grid;grid-template-columns:1.1fr .9fr;gap:16px}@media(max-width:860px){.hero{grid-template-columns:1fr}}
.preview{position:relative;background:#000;border-radius:16px;overflow:hidden}
video,canvas{width:100%;height:auto;display:block}
.overlayBadge{position:absolute;top:12px;left:12px;font-size:.8rem;background:rgba(0,0,0,.5);padding:6px 10px;border-radius:999px;color:#fff;backdrop-filter:blur(6px)}
.counterBadge{position:absolute;top:12px;right:12px;font-size:.8rem;background:rgba(255,77,141,.85);padding:6px 10px;border-radius:999px;color:#fff;display:none}
.controls{display:flex;gap:12px;align-items:center;justify-content:center;padding:12px}
.hint{font-size:.85rem;color:var(--muted)}
.toast{position:fixed;left:50%;transform:translateX(-50%);bottom:18px;background:#101012;color:#fff;border:1px solid #2a2a35;padding:10px 14px;border-radius:12px;box-shadow:0 8px 24px rgba(0,0,0,.4);opacity:0;transition:opacity .25s ease}
.toast.show{opacity:1}.small{font-size:.8rem;color:#9aa}
.thank{position:fixed;inset:0;background:rgba(0,0,0,.65);display:none;align-items:center;justify-content:center;z-index:50}
.thank .panel{background:var(--card);border:1px solid #333;border-radius:18px;padding:20px 22px;max-width:420px;text-align:center}
.unlock{position:fixed;inset:0;background:rgba(0,0,0,.8);display:none;align-items:center;justify-content:center;z-index:60}
.unlock .panel{background:#16161e;border:1px solid #444;border-radius:18px;padding:22px 24px;max-width:480px;text-align:center}
.form{display:grid;gap:10px;margin-top:8px}.field{display:grid;gap:6px}
input[type=text],input[type=email]{background:#0f0f15;border:1px solid #2e2e3a;color:#fff;border-radius:12px;padding:12px}
.subtle{font-size:.75rem;color:#8b8ba3}
</style>
</head>
<body>
<div class="wrap">
  <header>
    <div class="brand">CHEZ ‚Ä¢ Fan Photo Drop</div>
    <div class="badge" id="eventBadge">Perth ‚Ä¢ 22 Oct 2025</div>
  </header>

  <div class="card" id="landing">
    <h1>Take photos from the show ‚ú®</h1>
    <p>Tap below to open the camera. Snap a photo, confirm it, and it uploads privately to CHEZ‚Äôs Dropbox.</p>
    <div class="row" style="margin-top:12px">
      <button class="primary" id="startBtn">Take photos</button>
      <button class="ghost" id="libraryBtn">Choose from library</button>
    </div>
    <p class="hint">By uploading, you confirm you own the photo and allow CHEZ to repost with credit. No faces without consent.</p>
  </div>

  <div class="hero" style="margin-top:18px">
    <div class="preview card">
      <div class="overlayBadge" id="badge">Live camera</div>
      <div class="counterBadge" id="counter">#1</div>
      <video id="video" playsinline autoplay muted></video>
      <canvas id="canvas" style="display:none"></canvas>
    </div>
    <div class="card">
      <h1>Controls</h1>
      <div class="controls">
        <button class="primary" id="shutterBtn">‚óè Shutter</button>
        <button class="ghost" id="retakeBtn" disabled>Retake</button>
        <button class="ghost" id="confirmBtn" disabled>Confirm & Upload</button>
      </div>
      <div style="margin-top:10px">
        <label class="small">Effect:</label>
        <select id="effectSel">
          <option value="film">Film (grain + warm + vignette)</option>
          <option value="bw">B&W (crunchy)</option>
          <option value="clean">Clean (no effect)</option>
        </select>
      </div>
      <div style="margin-top:10px">
        <label class="small">Quality:</label>
        <input id="quality" type="range" min="0.5" max="0.95" step="0.05" value="0.85"/>
      </div>
      <div class="form">
        <div class="field">
          <label class="small">Instagram handle (optional)</label>
          <input id="ig" type="text" inputmode="text" placeholder="@yourhandle" autocomplete="off"/>
        </div>
        <div class="field">
          <label class="small">Email (optional)</label>
          <input id="email" type="email" inputmode="email" placeholder="you@example.com" autocomplete="off"/>
          <div class="subtle">If you add email, we may send a quick thank-you with community links.</div>
        </div>
      </div>
      <p class="hint">After upload: thank-you screen ‚Üí camera resets. Unlock a secret link after 5 uploads.</p>
      <input id="fileInput" type="file" accept="image/*" capture="environment" style="display:none"/>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<!-- Thank-you overlay -->
<div class="thank" id="thank">
  <div class="panel">
    <div id="thankMsg" style="font-size:1.1rem;margin-bottom:8px">Thanks, baddie ‚ú®</div>
    <div id="thankSub" class="small">Uploading‚Ä¶</div>
  </div>
</div>

<!-- Unlockable modal -->
<div class="unlock" id="unlock">
  <div class="panel">
    <h2 style="margin-top:0">üéÅ You unlocked a secret CHEZ demo</h2>
    <p class="hint" id="unlockCity">Thanks for capturing tonight.</p>
    <p><a id="unlockLink" class="badge" href="#" target="_blank" rel="noopener">Listen on SoundCloud</a></p>
    <div style="margin-top:10px"><button class="primary" id="closeUnlock">Back to camera</button></div>
  </div>
</div>

<script>
/* ===== FRONTEND CONFIG ===== */
const UPLOAD_ENDPOINT = 'https://chez-uploader.reece-lenzo.workers.dev/upload';
const EVENT_CODE = 'chez_2025_10_22_perth';
const EVENT_CITY = 'Perth';
const EVENT_DATE = '22 Oct 2025';
const UNLOCK_MIN_UPLOADS = 5;

const video = document.getElementById('video');
const canvas = document.getElementById('canvas');
const badge = document.getElementById('badge');
const counterBadge = document.getElementById('counter');
const startBtn = document.getElementById('startBtn');
const libraryBtn = document.getElementById('libraryBtn');
const fileInput = document.getElementById('fileInput');
const shutterBtn = document.getElementById('shutterBtn');
const retakeBtn = document.getElementById('retakeBtn');
const confirmBtn = document.getElementById('confirmBtn');
const effectSel = document.getElementById('effectSel');
const qualitySlider = document.getElementById('quality');
const toast = document.getElementById('toast');
const thank = document.getElementById('thank');
const thankMsg = document.getElementById('thankMsg');
const thankSub = document.getElementById('thankSub');
const unlock = document.getElementById('unlock');
const unlockLink = document.getElementById('unlockLink');
const unlockCity = document.getElementById('unlockCity');
const closeUnlock = document.getElementById('closeUnlock');
const eventBadge = document.getElementById('eventBadge');
const igInput = document.getElementById('ig');
const emailInput = document.getElementById('email');

let capturedBlob = null;

/* === Helpers === */
function showToast(msg){ toast.textContent = msg; toast.classList.add('show'); setTimeout(()=>toast.classList.remove('show'), 2200); }
function showThank(msg, sub){ thankMsg.textContent = msg; thankSub.textContent = sub || ''; thank.style.display = 'flex'; }
function hideThank(){ thank.style.display = 'none'; }
function togglePreviewState(isPreview){ retakeBtn.disabled = !isPreview; confirmBtn.disabled = !isPreview; shutterBtn.disabled = isPreview; badge.textContent = isPreview ? 'Preview' : 'Live camera'; }

/* === Camera init === */
async function waitForVideoReady(v) {
  if (v.readyState >= 2 && v.videoWidth && v.videoHeight) return;
  await new Promise(r => v.addEventListener('loadedmetadata', r, {once:true}));
  await new Promise(r => requestAnimationFrame(r));
}

async function initCamera(){
  try{
    video.setAttribute('playsinline','');
    video.setAttribute('muted','');
    video.muted = true;

    const stream = await navigator.mediaDevices.getUserMedia({
      video: { facingMode: { ideal: 'environment' } },
      audio: false
    });
    video.srcObject = stream;

    await waitForVideoReady(video);
    await video.play();

    badge.textContent = 'Live camera';
  }catch(err){
    console.error(err);
    badge.textContent = 'Camera unavailable ‚Äî pick from library';
  }
  eventBadge.textContent = `${EVENT_CITY} ‚Ä¢ ${EVENT_DATE}`;
}

/* === Events === */
startBtn.addEventListener('click', ()=>{ initCamera(); document.getElementById('landing').style.display='none'; });
libraryBtn.addEventListener('click', ()=> fileInput.click());

fileInput.addEventListener('change', async (e)=>{
  const file = e.target.files?.[0];
  if(file){ const img = await createImageBitmap(file); drawWithEffect(img); await prepareBlob(); togglePreviewState(true); }
});

shutterBtn.addEventListener('click', async ()=>{
  if (!video.videoWidth) await waitForVideoReady(video);
  drawWithEffect(video);
  await prepareBlob();
  togglePreviewState(true);
});

retakeBtn.addEventListener('click', ()=>{ capturedBlob=null; canvas.style.display='none'; video.style.display='block'; togglePreviewState(false); });

confirmBtn.addEventListener('click', async ()=>{
  if(!capturedBlob){ showToast('Nothing to upload yet'); return; }
  confirmBtn.disabled=true; showThank('Thanks, baddie ‚ú®','Uploading‚Ä¶');
  try{
    const form = new FormData();
    form.append('file', capturedBlob, `chez_${Date.now()}.jpg`);
    form.append('event', EVENT_CODE);
    form.append('effect', effectSel.value);
    form.append('city', EVENT_CITY);
    form.append('date', EVENT_DATE);
    if(igInput.value) form.append('ig', igInput.value.trim());
    if(emailInput.value) form.append('email', emailInput.value.trim());
    const count = incLocalCount(); form.append('client_uploads', String(count));

    const res = await fetch(UPLOAD_ENDPOINT, { method:'POST', body:form });
    const j = await res.json();
    counterBadge.style.display='block'; counterBadge.textContent = `#${j.count||'?'}`;
    thankSub.textContent = `You‚Äôre upload #${j.count||'?'}`;
    setTimeout(hideThank, 1400);

    if(j.unlock_url){ unlockLink.href=j.unlock_url; unlockCity.textContent=`Unlocked in ${EVENT_CITY} ‚Ä¢ ${EVENT_DATE}`; setTimeout(()=>unlock.style.display='flex',1500); }
    capturedBlob=null; togglePreviewState(false); canvas.style.display='none'; video.style.display='block';
  }catch(e){ console.error(e); thankMsg.textContent='Upload error'; thankSub.textContent='Try again'; setTimeout(hideThank,1600); confirmBtn.disabled=false; }
});

closeUnlock.addEventListener('click', ()=> unlock.style.display='none');

/* === Effects === */
function drawWithEffect(src){
  const w = src.videoWidth || src.width; const h = src.videoHeight || src.height;
  if(!w||!h){ showToast('Camera not ready'); return; }
  const scale=Math.min(1,1440/w); canvas.width=w*scale; canvas.height=h*scale;
  const ctx=canvas.getContext('2d',{willReadFrequently:true});
  ctx.drawImage(src,0,0,canvas.width,canvas.height);
  if(effectSel.value==='film') applyFilm(ctx,canvas);
  if(effectSel.value==='bw') applyBW(ctx,canvas);
  drawWatermark(ctx,canvas); canvas.style.display='block'; video.style.display='none';
}
function applyFilm(ctx,c){/* quick film effect */addGrain(ctx,c,0.18);addVignette(ctx,c,0.25);}
function applyBW(ctx,c){const img=ctx.getImageData(0,0,c.width,c.height);const d=img.data;for(let i=0;i<d.length;i+=4){const y=0.3*d[i]+0.59*d[i+1]+0.11*d[i+2];d[i]=d[i+1]=d[i+2]=y;}ctx.putImageData(img,0,0);addGrain(ctx,c,0.22);addVignette(ctx,c,0.3);}
function addGrain(ctx,c,int){const id=ctx.createImageData(c.width,c.height);for(let i=0;i<id.data.length;i+=4){const n=(Math.random()*255-128)*int;id.data[i]=id.data[i+1]=id.data[i+2]=128+n;id.data[i+3]=25;}ctx.putImageData(id,0,0);}
function addVignette(ctx,c,s){const g=ctx.createRadialGradient(c.width/2,c.height/2,Math.min(c.width,c.height)*0.2,c.width/2,c.height/2,Math.max(c.width,c.height)*0.7);g.addColorStop(0,'rgba(0,0,0,0)');g.addColorStop(1,`rgba(0,0,0,${s})`);ctx.fillStyle=g;ctx.fillRect(0,0,c.width,c.height);}
function drawWatermark(ctx,c){ctx.fillStyle='rgba(0,0,0,.45)';ctx.fillRect(c.width-200,c.height-30,190,24);ctx.fillStyle='#fff';ctx.font='bold 16px sans-serif';ctx.fillText(`CHEZ ‚Ä¢ ${EVENT_CITY} ${EVENT_DATE}`,c.width-190,c.height-12);}

/* === Blob === */
async function prepareBlob(){const q=parseFloat(qualitySlider.value||'0.85');return new Promise(r=>canvas.toBlob(b=>{capturedBlob=b;r();},'image/jpeg',q));}

/* === Local counter === */
function incLocalCount(){const k=`chez_up_count_${EVENT_CODE}`;const n=parseInt(localStorage.getItem(k)||'0',10)+1;localStorage.setItem(k,n);return n;}

/* === Boot === */
if(navigator.mediaDevices?.getUserMedia){ initCamera(); }
</script>
</body>
</html>
