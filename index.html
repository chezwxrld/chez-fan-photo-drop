<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
<title>CHEZ ‚Äî Fan Photo Drop</title>
<style>
:root{--bg:#0b0b0f;--fg:#f5f5f7;--muted:#a8a8b3;--accent:#ff4d8d;--card:#14141a}
*{box-sizing:border-box}body{margin:0;font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Inter,Helvetica,Arial;background:radial-gradient(1200px 700px at 80% -10%,#1b1b25 0%,#0b0b0f 60%);color:var(--fg)}
.wrap{max-width:980px;margin:0 auto;padding:16px 16px 64px}
header{display:flex;align-items:center;justify-content:space-between;padding:20px 0}
.brand{font-weight:800;letter-spacing:.5px}
.badge{font-size:.85rem;background:rgba(255,77,141,.08);border:1px solid rgba(255,77,141,.35);padding:6px 10px;border-radius:999px;color:#fff}
.card{background:var(--card);border:1px solid #2a2a35;border-radius:20px;padding:20px;box-shadow:0 10px 30px rgba(0,0,0,.35)}
h1{font-size:1.4rem;margin:0 0 6px}p{margin:.2rem 0;color:var(--muted)}
button{appearance:none;border:0;border-radius:14px;padding:14px 18px;font-size:1rem;font-weight:700;cursor:pointer}
.primary{background:linear-gradient(135deg,#ff4d8d,#ff7a59);color:white}.ghost{background:transparent;border:1px solid #3a3a45;color:var(--fg)}
.row{display:flex;gap:16px;flex-wrap:wrap}
.hero{display:grid;grid-template-columns:1.1fr .9fr;gap:16px}@media(max-width:860px){.hero{grid-template-columns:1fr}}
.preview{position:relative;background:#000;border-radius:16px;overflow:hidden}
video,canvas{width:100%;height:auto;display:block}
.overlayBadge{position:absolute;top:12px;left:12px;font-size:.8rem;background:rgba(0,0,0,.5);padding:6px 10px;border-radius:999px;color:#fff;backdrop-filter:blur(6px)}
.counterBadge{position:absolute;top:12px;right:12px;font-size:.8rem;background:rgba(255,77,141,.85);padding:6px 10px;border-radius:999px;color:#fff;display:none}
.controls{display:flex;gap:12px;align-items:center;justify-content:center;padding:12px}
.hint{font-size:.85rem;color:var(--muted)}
.toast{position:fixed;left:50%;transform:translateX(-50%);bottom:18px;background:#101012;color:#fff;border:1px solid #2a2a35;padding:10px 14px;border-radius:12px;box-shadow:0 8px 24px rgba(0,0,0,.4);opacity:0;transition:opacity .25s ease;z-index:90}
.toast.show{opacity:1}.small{font-size:.8rem;color:#9aa}
.thank{position:fixed;inset:0;background:rgba(0,0,0,.65);display:none;align-items:center;justify-content:center;z-index:80}
.thank .panel{background:var(--card);border:1px solid #333;border-radius:18px;padding:20px 22px;max-width:420px;text-align:center}
.unlock{position:fixed;inset:0;background:rgba(0,0,0,.8);display:none;align-items:center;justify-content:center;z-index:85}
.unlock .panel{background:#16161e;border:1px solid #444;border-radius:18px;padding:22px 24px;max-width:480px;text-align:center}
.form{display:grid;gap:10px;margin-top:8px}.field{display:grid;gap:6px}
input[type=text],input[type=email]{background:#0f0f15;border:1px solid #2e2e3a;color:#fff;border-radius:12px;padding:12px}
.subtle{font-size:.75rem;color:#8b8ba3}
</style>
</head>
<body>
<div class="wrap">
  <header>
    <div class="brand">CHEZ ‚Ä¢ Fan Photo Drop</div>
    <div class="badge" id="eventBadge">Perth ‚Ä¢ 22 Oct 2025</div>
  </header>

  <div class="card" id="landing">
    <h1>Take photos from the show ‚ú®</h1>
    <p>Tap below to open the camera. Snap a photo, confirm it, and it uploads privately to CHEZ‚Äôs Dropbox.</p>
    <div class="row" style="margin-top:12px">
      <button class="primary" id="startBtn">Take photos</button>
      <button class="ghost" id="libraryBtn">Choose from library</button>
    </div>
    <p class="hint">By uploading, you confirm you own the photo and allow CHEZ to repost with credit. No faces without consent.</p>
  </div>

  <div class="hero" style="margin-top:18px">
    <div class="preview card">
      <div class="overlayBadge" id="badge">Live camera</div>
      <div class="counterBadge" id="counter">#1</div>
      <video id="video" playsinline autoplay muted></video>
      <canvas id="canvas" style="display:none"></canvas>
    </div>
    <div class="card">
      <h1>Controls</h1>
      <div class="controls">
        <button class="primary" id="shutterBtn">‚óè Shutter</button>
        <button class="ghost" id="retakeBtn" disabled>Retake</button>
        <button class="ghost" id="confirmBtn" disabled>Confirm & Upload</button>
      </div>
      <div style="margin-top:10px">
        <label class="small">Effect:</label>
        <select id="effectSel">
          <option value="film">Film (grain + warm + vignette)</option>
          <option value="bw">B&W (crunchy)</option>
          <option value="clean">Clean (no effect)</option>
        </select>
      </div>
      <div style="margin-top:10px">
        <label class="small">Quality:</label>
        <input id="quality" type="range" min="0.5" max="0.95" step="0.05" value="0.85"/>
      </div>
      <div class="form">
        <div class="field">
          <label class="small">Instagram handle (optional)</label>
          <input id="ig" type="text" inputmode="text" placeholder="@yourhandle" autocomplete="off"/>
        </div>
        <div class="field">
          <label class="small">Email (optional)</label>
          <input id="email" type="email" inputmode="email" placeholder="you@example.com" autocomplete="off"/>
          <div class="subtle">If you add email, we may send a quick thank-you with community links.</div>
        </div>
      </div>
      <p class="hint">After upload: thank-you screen ‚Üí camera resets. Unlock a secret link after 5 uploads.</p>
      <input id="fileInput" type="file" accept="image/*" capture="environment" style="display:none"/>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<!-- Thank-you overlay -->
<div class="thank" id="thank">
  <div class="panel">
    <div id="thankMsg" style="font-size:1.1rem;margin-bottom:8px">Thanks, baddie ‚ú®</div>
    <div id="thankSub" class="small">Uploading‚Ä¶</div>
  </div>
</div>

<!-- Unlockable modal -->
<div class="unlock" id="unlock">
  <div class="panel">
    <h2 style="margin-top:0">üéÅ You unlocked a secret CHEZ demo</h2>
    <p class="hint" id="unlockCity">Thanks for capturing tonight.</p>
    <p><a id="unlockLink" class="badge" href="#" target="_blank" rel="noopener">Listen on SoundCloud</a></p>
    <div style="margin-top:10px"><button class="primary" id="closeUnlock">Back to camera</button></div>
  </div>
</div>

<script>
/* ===== FRONTEND CONFIG ===== */
const UPLOAD_ENDPOINT = 'https://chez-uploader.reece-lenzo.workers.dev/upload';
const EVENT_CODE = 'chez_2025_10_22_perth';
const EVENT_CITY = 'Perth';
const EVENT_DATE = '22 Oct 2025';
const UNLOCK_MIN_UPLOADS = 5;

/* ===== Elements ===== */
const video = document.getElementById('video');
const canvas = document.getElementById('canvas');
const badge = document.getElementById('badge');
const counterBadge = document.getElementById('counter');
const startBtn = document.getElementById('startBtn');
const libraryBtn = document.getElementById('libraryBtn');
const fileInput = document.getElementById('fileInput');
const shutterBtn = document.getElementById('shutterBtn');
const retakeBtn = document.getElementById('retakeBtn');
const confirmBtn = document.getElementById('confirmBtn');
const effectSel = document.getElementById('effectSel');
const qualitySlider = document.getElementById('quality');
const toast = document.getElementById('toast');
const thank = document.getElementById('thank');
const thankMsg = document.getElementById('thankMsg');
const thankSub = document.getElementById('thankSub');
const unlock = document.getElementById('unlock');
const unlockLink = document.getElementById('unlockLink');
const unlockCity = document.getElementById('unlockCity');
const closeUnlock = document.getElementById('closeUnlock');
const eventBadge = document.getElementById('eventBadge');
const igInput = document.getElementById('ig');
const emailInput = document.getElementById('email');

let capturedBlob = null;

/* ===== UI helpers ===== */
function showToast(msg){ toast.textContent = msg; toast.classList.add('show'); setTimeout(()=>toast.classList.remove('show'), 2200); }
function showThank(msg, sub){ thankMsg.textContent = msg; thankSub.textContent = sub || ''; thank.style.display = 'flex'; }
function hideThank(){ thank.style.display = 'none'; }
function togglePreviewState(isPreview){ retakeBtn.disabled = !isPreview; confirmBtn.disabled = !isPreview; shutterBtn.disabled = isPreview; badge.textContent = isPreview ? 'Preview' : 'Live camera'; }

/* ===== Camera ===== */
async function waitForVideoReady(v) {
  if (v.readyState >= 2 && v.videoWidth && v.videoHeight) return;
  await new Promise(r => v.addEventListener('loadedmetadata', r, { once:true }));
  await new Promise(r => requestAnimationFrame(r));
  // sometimes needs another frame
  if (!v.videoWidth) await new Promise(r => v.addEventListener('loadeddata', r, { once:true }));
}

async function initCamera(){
  try{
    video.setAttribute('playsinline',''); video.setAttribute('muted',''); video.muted = true;
    const stream = await navigator.mediaDevices.getUserMedia({
      video: { facingMode: { ideal: 'environment' } },
      audio: false
    });
    video.srcObject = stream;
    await waitForVideoReady(video);
    await video.play();
    badge.textContent = 'Live camera';
  }catch(err){
    console.error(err);
    badge.textContent = 'Camera unavailable ‚Äî pick from library';
  }
  eventBadge.textContent = `${EVENT_CITY} ‚Ä¢ ${EVENT_DATE}`;
}

/* ===== Capture helpers (robust for iOS + Android) ===== */
async function captureFrameBitmap(){
  const track = video.srcObject?.getVideoTracks?.()[0];
  if (!track) return null;

  // Prefer takePhoto (produces oriented, full-res blobs on many Androids)
  if ('ImageCapture' in window) {
    try {
      const ic = new ImageCapture(track);
      if (ic.takePhoto) {
        const blob = await ic.takePhoto();
        return await createImageBitmap(blob);
      }
    } catch(e) { /* ignore & try grabFrame */ }
    try {
      const ic2 = new ImageCapture(track);
      if (ic2.grabFrame) return await ic2.grabFrame();
    } catch(e) { /* ignore */ }
  }
  return null; // caller will fall back to video draw
}

function frameLooksBlack(ctx, w, h){
  // sample a small grid to detect a black draw
  const sample = ctx.getImageData(Math.max(0,w-16), Math.max(0,h-16), Math.min(16,w), Math.min(16,h)).data;
  let sum = 0; for(let i=0;i<sample.length;i+=4){ sum += sample[i]*0.2126 + sample[i+1]*0.7152 + sample[i+2]*0.0722; }
  const avg = sum / (sample.length/4);
  return avg < 2; // essentially black
}

/* ===== Events ===== */
startBtn.addEventListener('click', ()=>{ initCamera(); document.getElementById('landing').style.display='none'; });
libraryBtn.addEventListener('click', ()=> fileInput.click());

fileInput.addEventListener('change', async (e)=>{
  const file = e.target.files?.[0];
  if(!file) return;
  let bmp = null;
  if ('createImageBitmap' in window) {
    try { bmp = await createImageBitmap(file); } catch {}
  }
  if (!bmp) {
    // Fallback for older iOS: FileReader -> HTMLImageElement
    const img = await new Promise((res, rej)=>{
      const fr = new FileReader();
      fr.onload = ()=>{ const im = new Image(); im.onload = ()=>res(im); im.onerror = rej; im.src = fr.result; };
      fr.onerror = rej; fr.readAsDataURL(file);
    });
    drawWithEffect(img);
  } else {
    drawWithEffect(bmp);
  }
  await prepareBlob();
  togglePreviewState(true);
});

shutterBtn.addEventListener('click', async ()=>{
  if (!video.videoWidth) await waitForVideoReady(video);

  // Try robust camera-track capture first
  let bmp = await captureFrameBitmap();

  if (bmp) {
    drawWithEffect(bmp);
  } else {
    // Fallback: draw from <video>, retry if black (iOS quirk)
    drawWithEffect(video);
    // If black, wait a couple animation frames and retry up to 2 times
    let tries = 0;
    while (tries < 2 && isCanvasBlack()) {
      await new Promise(r => requestAnimationFrame(r));
      drawWithEffect(video);
      tries++;
    }
  }

  await prepareBlob();
  togglePreviewState(true);
});

function isCanvasBlack(){
  const ctx = canvas.getContext('2d');
  return frameLooksBlack(ctx, canvas.width, canvas.height);
}

retakeBtn.addEventListener('click', ()=>{
  capturedBlob=null; canvas.style.display='none'; video.style.display='block'; togglePreviewState(false);
});

confirmBtn.addEventListener('click', async ()=>{
  if(!capturedBlob){ showToast('Nothing to upload yet'); return; }
  confirmBtn.disabled=true; showThank('Thanks, baddie ‚ú®','Uploading‚Ä¶');
  try{
    const form = new FormData();
    form.append('file', capturedBlob, `chez_${Date.now()}.jpg`);
    form.append('event', EVENT_CODE);
    form.append('effect', effectSel.value);
    form.append('city', EVENT_CITY);
    form.append('date', EVENT_DATE);
    if(igInput.value) form.append('ig', igInput.value.trim());
    if(emailInput.value) form.append('email', emailInput.value.trim());
    const count = incLocalCount(); form.append('client_uploads', String(count));

    const res = await fetch(UPLOAD_ENDPOINT, { method:'POST', body:form });
    const j = await res.json();

    counterBadge.style.display='block'; counterBadge.textContent = `#${j.count||'?'}`;
    thankSub.textContent = `You‚Äôre upload #${j.count||'?'}`;
    setTimeout(hideThank, 1400);

    if(j.unlock_url){ unlockLink.href=j.unlock_url; unlockCity.textContent=`Unlocked in ${EVENT_CITY} ‚Ä¢ ${EVENT_DATE}`; setTimeout(()=>unlock.style.display='flex',1500); }

    capturedBlob=null; togglePreviewState(false); canvas.style.display='none'; video.style.display='block';
  }catch(e){ console.error(e); thankMsg.textContent='Upload error'; thankSub.textContent='Try again'; setTimeout(hideThank,1600); confirmBtn.disabled=false; }
});

closeUnlock.addEventListener('click', ()=> unlock.style.display='none');

/* ===== Effects (visible & punchy) ===== */
function drawWithEffect(src){
  const w = src.videoWidth || src.width; const h = src.videoHeight || src.height;
  if(!w||!h){ showToast('Camera not ready'); return; }
  const scale=Math.min(1, 1440/w);
  canvas.width = Math.round(w*scale); canvas.height = Math.round(h*scale);
  const ctx = canvas.getContext('2d', { willReadFrequently:true });
  ctx.imageSmoothingEnabled = true;

  ctx.drawImage(src, 0, 0, canvas.width, canvas.height);

  const fx = effectSel.value;
  if (fx === 'film')      applyFilm(ctx, canvas);
  else if (fx === 'bw')   applyBW(ctx, canvas);
  // 'clean' = no effect

  drawWatermark(ctx, canvas);
  canvas.style.display='block'; video.style.display='none';
}

function applyFilm(ctx, cvs){
  const img = ctx.getImageData(0,0,cvs.width,cvs.height);
  const d = img.data;
  // Contrast curve + warm tint + gentle roll-off highlights (very visible)
  for(let i=0;i<d.length;i+=4){
    let r=d[i], g=d[i+1], b=d[i+2];
    // S-curve
    const map = (v)=> {
      const t = v/255;
      const s = t<0.5 ? (2.2*t*t) : (1 - Math.pow(-2.2*t+2.2,2)/2.2);
      return Math.max(0, Math.min(255, s*255));
    };
    r = map(r); g = map(g); b = map(b);
    // warm tint
    r = r*1.08 + 4; g = g*1.02 + 1; b = b*0.98 - 2;
    // highlight roll-off
    const lum = 0.2126*r + 0.7152*g + 0.0722*b;
    if (lum > 220) { const k = 1 - (lum-220)/80; r*=k; g*=k; b*=k; }
    d[i]=clamp(r); d[i+1]=clamp(g); d[i+2]=clamp(b);
  }
  ctx.putImageData(img,0,0);
  addGrain(ctx,cvs,0.22);
  addVignette(ctx,cvs,0.28);
}

function applyBW(ctx,cvs){
  const img = ctx.getImageData(0,0,cvs.width,cvs.height);
  const d = img.data;
  for(let i=0;i<d.length;i+=4){
    const y = 0.299*d[i] + 0.587*d[i+1] + 0.114*d[i+2];
    // strong contrast
    let v = (y-128)*1.25 + 128;
    d[i]=d[i+1]=d[i+2]=clamp(v);
  }
  ctx.putImageData(img,0,0);
  addGrain(ctx,cvs,0.26);
  addVignette(ctx,cvs,0.35);
}

function clamp(v){ return v<0?0:(v>255?255:v); }

function addGrain(ctx,cvs,intensity){
  const {width:w,height:h}=cvs;
  const img = ctx.getImageData(0,0,w,h);
  const d = img.data;
  for(let i=0;i<d.length;i+=4){
    const n = (Math.random()*2-1) * 40 * intensity; // visible grain
    d[i]   = clamp(d[i]   + n);
    d[i+1] = clamp(d[i+1] + n);
    d[i+2] = clamp(d[i+2] + n);
  }
  ctx.putImageData(img,0,0);
}

function addVignette(ctx,cvs,strength){
  const g = ctx.createRadialGradient(cvs.width/2,cvs.height/2, Math.min(cvs.width,cvs.height)*0.25, cvs.width/2,cvs.height/2, Math.max(cvs.width,cvs.height)*0.75);
  g.addColorStop(0,'rgba(0,0,0,0)');
  g.addColorStop(1,`rgba(0,0,0,${strength})`);
  ctx.fillStyle=g; ctx.fillRect(0,0,cvs.width,cvs.height);
}

function drawWatermark(ctx,cvs){
  const text = `CHEZ ‚Ä¢ ${EVENT_CITY} ${EVENT_DATE}`;
  const pad = Math.round(cvs.width * 0.02);
  ctx.save();
  ctx.font = 'bold 18px Inter, system-ui, sans-serif';
  const metrics = ctx.measureText(text);
  const w = metrics.width + pad*0.8, h = 26;
  const x = cvs.width - w - pad, y = cvs.height - pad;
  // pill bg
  ctx.fillStyle='rgba(0,0,0,.5)';
  const r=12;
  ctx.beginPath();
  ctx.moveTo(x+r,y-h); ctx.arcTo(x+w,y-h,x+w,y,r);
  ctx.arcTo(x+w,y,x,y,r); ctx.arcTo(x,y,x,y-h,r); ctx.arcTo(x,y-h,x+w,y-h,r); ctx.closePath(); ctx.fill();
  // text
  ctx.fillStyle='#fff'; ctx.fillText(text, x+10, y-8);
  ctx.restore();
}

/* ===== Blob prep ===== */
async function prepareBlob(){
  const q=parseFloat(qualitySlider.value||'0.85');
  return new Promise(res=>canvas.toBlob(b=>{ capturedBlob=b; res(); },'image/jpeg',q));
}

/* ===== Local unlock counter ===== */
function incLocalCount(){
  const key = `chez_up_count_${EVENT_CODE}`;
  const n = (parseInt(localStorage.getItem(key)||'0',10) || 0) + 1;
  localStorage.setItem(key, String(n));
  return n;
}

/* ===== Boot ===== */
if(navigator.mediaDevices?.getUserMedia){ initCamera(); }
</script>
</body>
</html>
