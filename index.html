<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>CHEZ ‚Äî Fan Photo Drop</title>
<style>
:root{--bg:#0b0b0f;--fg:#f5f5f7;--muted:#a8a8b3;--card:#15151c;--accent:#ff4d8d}
*{box-sizing:border-box}body{margin:0;background:radial-gradient(1100px 700px at 80% -10%,#1a1a23 0,#0b0b0f 60%);color:var(--fg);font:16px/1.45 Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial}
.wrap{max-width:960px;margin:0 auto;padding:16px 16px 64px}
header{display:flex;justify-content:space-between;align-items:center;padding:18px 0}
.brand{font-weight:800} .badge{background:rgba(255,77,141,.1);border:1px solid rgba(255,77,141,.35);padding:6px 10px;border-radius:999px}
.card{background:var(--card);border:1px solid #2a2a35;border-radius:16px;padding:16px;box-shadow:0 10px 30px rgba(0,0,0,.35)}
.hero{display:grid;grid-template-columns:1.1fr .9fr;gap:14px}@media(max-width:860px){.hero{grid-template-columns:1fr}}
.preview{position:relative;background:#000;border-radius:14px;overflow:hidden}
#video{position:relative;z-index:1;width:100%;display:block}
#liveCanvas{position:absolute;inset:0;z-index:2;display:none;width:100%;height:100%}
#canvas{position:absolute;inset:0;z-index:3;display:none;width:100%;height:100%}
.overlay{position:absolute;top:10px;left:10px;background:rgba(0,0,0,.5);backdrop-filter:blur(6px);padding:6px 10px;border-radius:999px}
.counter{position:absolute;top:10px;right:10px;background:rgba(255,77,141,.85);color:#fff;padding:6px 10px;border-radius:999px;display:none}
.ring{position:absolute;right:10px;bottom:10px;width:44px;height:44px;border-radius:50%;display:none;background:conic-gradient(#ff7a59 var(--p,0%), rgba(255,255,255,.15) 0)}
.ring::after{content:"";position:absolute;inset:6px;border-radius:50%;background:#0f0f15;box-shadow:0 0 0 1px #333 inset}
.controls{display:flex;gap:10px;flex-wrap:wrap;margin-top:8px}
button{appearance:none;border:0;border-radius:12px;padding:12px 16px;font-weight:700;cursor:pointer}
.primary{background:linear-gradient(135deg,#ff4d8d,#ff7a59);color:#fff}
.ghost{background:transparent;border:1px solid #3a3a45;color:#fff}
.input{width:100%;background:#0f0f15;border:1px solid #2e2e3a;color:#fff;border-radius:12px;padding:12px}
.small{font-size:.85rem;color:#a9a9b2}
.toast{position:fixed;left:50%;transform:translateX(-50%);bottom:18px;background:#111218;border:1px solid #2b2b35;color:#fff;padding:10px 14px;border-radius:10px;opacity:0;transition:.25s;z-index:90}
.toast.show{opacity:1}
.modal{position:fixed;inset:0;background:rgba(0,0,0,.7);display:none;align-items:center;justify-content:center;z-index:85}
.panel{background:#16161e;border:1px solid #343446;border-radius:14px;padding:18px 20px;max-width:460px;text-align:center}

/* mirror the LIVE preview only for front camera */
.mirror { transform: scaleX(-1); }
</style>
</head>
<body>
<div class="wrap">
  <header>
    <div class="brand">CHEZ ‚Ä¢ Fan Photo Drop</div>
    <div id="eventBadge" class="badge">Locating‚Ä¶</div>
  </header>

  <div class="card" id="landing">
    <h2 style="margin:6px 0 8px">Take photos from the show ‚ú®</h2>
    <p class="small">Live filter preview ‚Ä¢ Private upload ‚Ä¢ Watermark with city & date</p>
    <div class="controls">
      <button id="startBtn" class="primary">Open Camera</button>
      <button id="pickBtn" class="ghost">Choose from Library</button>
    </div>
  </div>

  <div class="hero" style="margin-top:14px">
    <div class="preview card">
      <div class="overlay" id="status">Live camera</div>
      <div class="counter" id="counter">#1</div>
      <div class="ring" id="ring"></div>
      <video id="video" playsinline autoplay muted></video>
      <canvas id="liveCanvas"></canvas>
      <canvas id="canvas"></canvas>
    </div>

    <div class="card">
      <h3 style="margin:6px 0 10px">Controls</h3>
      <div class="controls">
        <button id="shutter" class="primary">‚óè Shutter</button>
        <button id="retake" class="ghost" disabled>Retake</button>
        <button id="confirm" class="ghost" disabled>Confirm & Upload</button>
        <!-- NEW: Flip button -->
        <button id="flip" class="ghost" title="Switch camera">Flip</button>
      </div>

      <div class="controls">
        <label class="small">Effect&nbsp;
          <select id="effect">
            <option value="film">Film (warm + grain + vignette)</option>
            <option value="bw">B&W (crunchy)</option>
            <option value="clean">Clean</option>
          </select>
        </label>
        <label class="small">Quality&nbsp;
          <input id="quality" type="range" min="0.6" max="0.9" step="0.05" value="0.8" />
        </label>
        <label class="small"><input id="lowlight" type="checkbox" /> Low-light boost</label>
      </div>

      <div style="display:grid;gap:10px;margin-top:10px">
        <div><label class="small">Instagram (optional)</label><input id="ig" class="input" placeholder="@yourhandle" /></div>
        <div><label class="small">Email (optional)</label><input id="email" type="email" class="input" placeholder="you@example.com" /></div>
      </div>

      <input id="fileInput" type="file" accept="image/*" capture="environment" style="display:none" />
    </div>
  </div>
</div>

<div id="toast" class="toast"></div>

<div id="thanks" class="modal">
  <div class="panel">
    <h3 style="margin-top:0">Thanks, baddie ‚ú®</h3>
    <p id="thanksSub" class="small">Uploading‚Ä¶</p>
  </div>
</div>

<div id="unlock" class="modal">
  <div class="panel">
    <h3 style="margin-top:0">üéÅ You unlocked a secret CHEZ link</h3>
    <p id="unlockCity" class="small"></p>
    <p><a id="unlockLink" class="badge" href="#" target="_blank" rel="noopener">Open</a></p>
    <button id="closeUnlock" class="primary">Back to camera</button>
  </div>
</div>

<script>
/* ====== CONFIG ====== */
const UPLOAD_ENDPOINT = 'https://chez-uploader.reece-lenzo.workers.dev/upload';
const UNLOCK_MIN_UPLOADS = 5;

/* ====== Elements ====== */
const video = document.getElementById('video');
const liveCanvas = document.getElementById('liveCanvas');
const canvas = document.getElementById('canvas');
const statusEl = document.getElementById('status');
const ring = document.getElementById('ring');
const counter = document.getElementById('counter');
const startBtn = document.getElementById('startBtn');
const pickBtn = document.getElementById('pickBtn');
const fileInput = document.getElementById('fileInput');
const shutter = document.getElementById('shutter');
const retake = document.getElementById('retake');
const confirmBtn = document.getElementById('confirm');
const effectSel = document.getElementById('effect');
const quality = document.getElementById('quality');
const lowlight = document.getElementById('lowlight');
const ig = document.getElementById('ig');
const email = document.getElementById('email');
const toast = document.getElementById('toast');
const thanks = document.getElementById('thanks');
const thanksSub = document.getElementById('thanksSub');
const unlock = document.getElementById('unlock');
const unlockLink = document.getElementById('unlockLink');
const unlockCity = document.getElementById('unlockCity');
const closeUnlock = document.getElementById('closeUnlock');
const eventBadge = document.getElementById('eventBadge');
const flipBtn = document.getElementById('flip');

/* ====== State ====== */
let EVENT_CITY = 'Tour', EVENT_DATE = '', EVENT_CODE = 'chez_tour';
let liveCtx = liveCanvas.getContext('2d');
let capturedBlob = null;

/* NEW: camera facing + stream handle */
let currentFacing = 'environment'; // or 'user'
let currentStream = null;

/* ====== Helpers ====== */
function showToast(msg){ toast.textContent = msg; toast.classList.add('show'); setTimeout(()=>toast.classList.remove('show'), 2200); }
function togglePreview(isPreview){ retake.disabled = !isPreview; confirmBtn.disabled = !isPreview; shutter.disabled = isPreview; statusEl.textContent = isPreview?'Preview':'Live camera'; }
function ringSet(p){ ring.style.setProperty('--p', `${p}%`); }
let ringTick=null; function ringStart(){ if(ringTick) return; ring.style.display='block'; let t0=performance.now(); ringTick=()=>{ const t=(performance.now()-t0)/1000; const p=5+80*(1-Math.exp(-t*1.6)); ringSet(Math.min(90,p)); ringTick&&requestAnimationFrame(ringTick); }; requestAnimationFrame(ringTick); }
function ringStop(ok=true){ ringTick=null; if(ok){ ringSet(100); setTimeout(()=>{ ring.style.display='none'; ringSet(0); },220);} else { ring.style.display='none'; ringSet(0); } }
function scaleTo1080(w,h){ const max=1080; const s=Math.min(1,max/Math.max(w,h)); return { w:Math.round(w*s), h:Math.round(h*s) }; }
function toBlobSafe(cvs, q){ return new Promise((res,rej)=> cvs.toBlob(b=> b?res(b):rej(new Error('toBlob null')),'image/jpeg',q)); }
async function sha256Hex(blob){ const buf=await blob.arrayBuffer(); const hash=await crypto.subtle.digest('SHA-256', buf); return Array.from(new Uint8Array(hash)).map(b=>b.toString(16).padStart(2,'0')).join(''); }
function drawWatermark(ctx,cvs){ const text=`CHEZ ‚Ä¢ ${EVENT_CITY} ${EVENT_DATE}`; const pad=Math.round(cvs.width*0.02); ctx.save(); ctx.font='bold 18px Inter,system-ui'; const w=ctx.measureText(text).width+pad*0.8, h=26; const x=cvs.width-w-pad, y=cvs.height-pad; ctx.fillStyle='rgba(0,0,0,.5)'; const r=12; ctx.beginPath(); ctx.moveTo(x+r,y-h); ctx.arcTo(x+w,y-h,x+w,y,r); ctx.arcTo(x+w,y,x,y,r); ctx.arcTo(x,y,x,y-h,r); ctx.arcTo(x,y-h,x+w,y-h,r); ctx.closePath(); ctx.fill(); ctx.fillStyle='#fff'; ctx.fillText(text,x+10,y-8); ctx.restore(); }

/* unified look: live == saved */
const LOOKS = { film:{ tint:'rgba(255,180,120,0.06)', vignette:.20, grain:.18 }, bw:{ gray:'hsl(0,0%,50%)', vignette:.25 } };
let noise=null, nctx=null; function ensureNoise(){ if(noise) return; noise=document.createElement('canvas'); noise.width=noise.height=256; nctx=noise.getContext('2d'); regenNoise(); }
function regenNoise(){ const id=nctx.createImageData(256,256); const d=id.data; for(let i=0;i<d.length;i+=4){ const v=127+(Math.random()*256-128); d[i]=d[i+1]=d[i+2]=v; d[i+3]=255; } nctx.putImageData(id,0,0); }
function addVignette(ctx,cvs,s){ const g=ctx.createRadialGradient(cvs.width/2,cvs.height/2,Math.min(cvs.width,cvs.height)*0.25,cvs.width/2,cvs.height/2,Math.max(cvs.width,cvs.height)*0.8); g.addColorStop(0,'rgba(0,0,0,0)'); g.addColorStop(1,`rgba(0,0,0,${s})`); ctx.fillStyle=g; ctx.fillRect(0,0,cvs.width,cvs.height); }
function applyLook(ctx,cvs,fx){ if(!fx||fx==='clean') return; if(fx==='film'){ const {tint,vignette,grain}=LOOKS.film; ctx.globalCompositeOperation='overlay'; ctx.fillStyle=tint; ctx.fillRect(0,0,cvs.width,cvs.height); addVignette(ctx,cvs,vignette); ensureNoise(); ctx.globalAlpha=grain; for(let y=0;y<cvs.height;y+=noise.height){ for(let x=0;x<cvs.width;x+=noise.width){ ctx.drawImage(noise,x,y); } } ctx.globalAlpha=1; ctx.globalCompositeOperation='source-over'; } if(fx==='bw'){ ctx.globalCompositeOperation='saturation'; ctx.fillStyle=LOOKS.bw.gray; ctx.fillRect(0,0,cvs.width,cvs.height); ctx.globalCompositeOperation='source-over'; addVignette(ctx,cvs,LOOKS.bw.vignette); } }

/* city + date (offline-safe) */
(function initMeta(){ const tz = (Intl.DateTimeFormat().resolvedOptions().timeZone||'UTC').split('/').pop().replace('_',' '); EVENT_CITY = tz||'On Tour'; const d=new Date(); EVENT_DATE=d.toLocaleDateString(undefined,{day:'2-digit',month:'short',year:'numeric'}); EVENT_CODE=`chez_${d.getFullYear()}_${String(d.getMonth()+1).padStart(2,'0')}_${String(d.getDate()).padStart(2,'0')}_${EVENT_CITY.toLowerCase().replace(/\s+/g,'')}`; eventBadge.textContent=`${EVENT_CITY} ‚Ä¢ ${EVENT_DATE}`; })();

/* camera */
async function waitReady(v){ if(v.readyState>=2 && v.videoWidth) return; await new Promise(r=>v.addEventListener('loadedmetadata',r,{once:true})); }

/* UPDATED: startCamera now supports front/back and stops previous stream */
async function startCamera(facing = currentFacing){
  try{
    // stop any previous tracks before switching
    if (currentStream) currentStream.getTracks().forEach(t => t.stop());

    video.muted=true;
    const cons={ video:{ facingMode:{ideal:facing} }, audio:false };
    if(lowlight.checked) cons.video.advanced=[{torch:true}];

    currentStream = await navigator.mediaDevices.getUserMedia(cons);
    video.srcObject=currentStream;

    await waitReady(video);
    await video.play();

    // mirror live preview ONLY for front camera
    const isFront = facing === 'user';
    video.classList.toggle('mirror', isFront);
    liveCanvas.classList.toggle('mirror', isFront);

    liveCanvas.width=video.videoWidth;
    liveCanvas.height=video.videoHeight;
    liveCanvas.style.display='block';
    statusEl.textContent='Live camera';
    currentFacing = facing;
    liveLoop();
  }catch(e){
    console.error(e);
    statusEl.textContent='Camera unavailable ‚Äî choose from library';
  }
}

function liveLoop(){ if(!video.videoWidth) return requestAnimationFrame(liveLoop); liveCtx.drawImage(video,0,0,liveCanvas.width,liveCanvas.height); applyLook(liveCtx, liveCanvas, effectSel.value); requestAnimationFrame(liveLoop); }

/* capture ‚Üí preview overlay */
async function capture(){
  if(!video.videoWidth) return;
  const {w,h}=scaleTo1080(video.videoWidth, video.videoHeight);
  canvas.width=w; canvas.height=h;
  const ctx=canvas.getContext('2d');

  // If using front camera, un-mirror the SAVED image
  const isFront = currentFacing === 'user';
  if (isFront) {
    ctx.save();
    ctx.translate(w, 0);
    ctx.scale(-1, 1);
    ctx.drawImage(video, 0, 0, w, h);
    ctx.restore();
  } else {
    ctx.drawImage(video, 0, 0, w, h);
  }

  applyLook(ctx,canvas,effectSel.value);
  drawWatermark(ctx,canvas);
  liveCanvas.style.display='none';
  canvas.style.display='block';
  togglePreview(true);
}

/* build blob reliably */
async function buildBlob(){ const q=parseFloat(quality.value||'0.8'); const b=await toBlobSafe(canvas,q); if(!b || !b.size) throw new Error('Capture failed (empty blob)'); capturedBlob=b; }

/* local counter + achievements */
function bumpLocal(){ const k=`chez_up_count_${EVENT_CODE}`; const n=(parseInt(localStorage.getItem(k)||'0',10)||0)+1; localStorage.setItem(k,String(n)); return n; }

/* offline queue (light) */
const QKEY='chez_queue'; function loadQ(){ try{return JSON.parse(localStorage.getItem(QKEY)||'[]')}catch{return[]} } function saveQ(q){ localStorage.setItem(QKEY, JSON.stringify(q.slice(0,5))); }
async function queueCurrent(){ const rdr=new FileReader(); return new Promise(res=>{ rdr.onload=()=>{ const item={ meta:{event:EVENT_CODE,effect:effectSel.value,city:EVENT_CITY,date:EVENT_DATE,ig:ig.value.trim(),email:email.value.trim()}, blob:rdr.result }; const q=loadQ(); q.push(item); saveQ(q); res(); }; rdr.readAsDataURL(capturedBlob); }); }
function b64ToBlob(dataURL){ const [h,d]=dataURL.split(','); const mime=h.match(/:(.*?);/)[1]; const bin=atob(d); const arr=new Uint8Array(bin.length); for(let i=0;i<bin.length;i++) arr[i]=bin.charCodeAt(i); return new Blob([arr],{type:mime}); }
async function flushQ(){ const q=loadQ(); if(!q.length) return; const it=q[0]; const blob=b64ToBlob(it.blob); const ok = await uploadBlob(blob, it.meta); if(ok){ q.shift(); saveQ(q); showToast(`Queued upload sent (${q.length} left)`); } }
window.addEventListener('online', flushQ); setInterval(flushQ, 5000);

/* core upload (shows detailed errors) */
async function uploadBlob(blob, meta){
  const checksum = await sha256Hex(blob);
  const count = bumpLocal();
  const fd = new FormData();
  fd.append('file', blob, `chez_${Date.now()}.jpg`); // MUST be 'file'
  fd.append('event', meta.event || EVENT_CODE);
  fd.append('effect', meta.effect || effectSel.value);
  fd.append('city', meta.city || EVENT_CITY);
  fd.append('date', meta.date || EVENT_DATE);
  if (meta.ig)    fd.append('ig', meta.ig);
  if (meta.email) fd.append('email', meta.email);
  fd.append('client_uploads', String(count));
  fd.append('checksum', checksum);

  ringStart();
  const res = await fetch(UPLOAD_ENDPOINT, { method:'POST', body: fd });
  let payload=null; try{ payload=await res.json(); }catch{}
  ringStop(res.ok && payload?.ok);

  if (!res.ok || !payload?.ok){
    const msg = (payload?.error || `HTTP ${res.status}`) + (payload?.dropbox ? ` ‚Ä¢ ${payload.dropbox}` : '');
    console.warn('Upload error:', payload);
    showToast(msg.slice(0,180));
    return false;
  }

  counter.style.display='block';
  counter.textContent = `#${payload.count||'?'}`;
  if (payload.unlock_url){
    unlockLink.href = payload.unlock_url;
    unlockCity.textContent = `Unlocked in ${EVENT_CITY} ‚Ä¢ ${EVENT_DATE}`;
    setTimeout(()=> unlock.style.display='flex', 800);
  }
  return true;
}

/* ====== Events ====== */
startBtn.onclick = ()=>{ startCamera('environment'); document.getElementById('landing').style.display='none'; };
pickBtn.onclick = ()=> fileInput.click();
fileInput.onchange = async e => {
  const file=e.target.files?.[0]; if(!file) return;
  const img = await createImageBitmap(file);
  const {w,h}=scaleTo1080(img.width,img.height);
  canvas.width=w; canvas.height=h;
  const ctx=canvas.getContext('2d'); ctx.drawImage(img,0,0,w,h); applyLook(ctx,canvas,effectSel.value); drawWatermark(ctx,canvas);
  liveCanvas.style.display='none'; canvas.style.display='block'; togglePreview(true);
};

shutter.onclick = async ()=> { await capture(); };

retake.onclick = ()=> {
  capturedBlob=null;
  canvas.style.display='none';
  liveCanvas.style.display='block';
  togglePreview(false);
};

confirmBtn.onclick = async ()=>{
  try{
    await buildBlob(); // ensures real JPEG blob exists
  }catch(e){ showToast(e.message); return; }

  confirmBtn.disabled=true;
  thanks.style.display='flex'; thanksSub.textContent='Uploading‚Ä¶';

  const ok = await uploadBlob(capturedBlob, {event:EVENT_CODE,effect:effectSel.value,city:EVENT_CITY,date:EVENT_DATE,ig:ig.value.trim(),email:email.value.trim()});
  if (!ok){
    await queueCurrent(); // save for retry
    thanksSub.textContent='Saved to retry when online';
    setTimeout(()=> thanks.style.display='none', 1200);
    confirmBtn.disabled=false;
    return;
  }

  thanksSub.textContent='Done! Resetting‚Ä¶';
  setTimeout(()=> thanks.style.display='none', 900);
  confirmBtn.disabled=false;
  // reset to live
  capturedBlob=null;
  canvas.style.display='none';
  liveCanvas.style.display='block';
  togglePreview(false);
};

/* NEW: flip camera */
flipBtn.onclick = async () => {
  const next = currentFacing === 'environment' ? 'user' : 'environment';
  await startCamera(next);
};

/* unlock modal close */
closeUnlock.onclick = ()=> unlock.style.display='none';

/* set initial city/date */
(function initBadge(){
  const tzCity=(Intl.DateTimeFormat().resolvedOptions().timeZone||'UTC').split('/').pop().replace('_',' ');
  EVENT_CITY=tzCity||'On Tour';
  const d=new Date();
  EVENT_DATE=d.toLocaleDateString(undefined,{day:'2-digit',month:'short',year:'numeric'});
  EVENT_CODE=`chez_${d.getFullYear()}_${String(d.getMonth()+1).padStart(2,'0')}_${String(d.getMonth()+1).padStart(2,'0')}_${EVENT_CITY.toLowerCase().replace(/\s+/g,'')}`;
  // ^^ NOTE: if you previously had day twice, keep your prior logic; otherwise:
})();

/* keep original badge text behavior */
(function fixBadge(){
  const d=new Date();
  EVENT_DATE=d.toLocaleDateString(undefined,{day:'2-digit',month:'short',year:'numeric'});
  eventBadge.textContent=`${EVENT_CITY} ‚Ä¢ ${EVENT_DATE}`;
})();
</script>
</body>
</html>
